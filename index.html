<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HS Nav Anchor</title>
    
    <!-- iOS PWA Meta Etiketleri -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hotspot">
    <link rel="apple-touch-icon" href="https://www.google.com/favicon.ico">

    <style>
        :root {
            --bg: #000000;
            --ios-blue: #0A84FF;
            --ios-green: #30D158;
            --ios-red: #FF453A;
            --surface: #1C1C1E;
            --text-secondary: #8E8E93;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none;
        }

        .safe-top { height: env(safe-area-inset-top); }
        .safe-bottom { height: env(safe-area-inset-bottom); }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
        }

        .header { text-align: center; width: 100%; }
        
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--surface);
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .status-pill.active {
            border-color: var(--ios-blue);
            color: var(--ios-blue);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.2);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
        }

        .active .pulse-dot {
            background: var(--ios-blue);
            animation: pulse-glow 1.5s infinite;
        }

        @keyframes pulse-glow {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .main-display {
            position: relative;
            width: 280px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid var(--ios-blue);
            border-radius: 50%;
            opacity: 0;
        }

        .active .radar-ring { animation: radar-wave 4s infinite linear; }
        .active .radar-ring:nth-child(2) { animation-delay: 1.33s; }
        .active .radar-ring:nth-child(3) { animation-delay: 2.66s; }

        @keyframes radar-wave {
            0% { transform: scale(0.3); opacity: 0.8; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        .control-btn {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: none;
            background: var(--ios-blue);
            color: white;
            font-size: 22px;
            font-weight: 800;
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .control-btn.active {
            background: var(--ios-red);
            transform: scale(0.95);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 100%;
            max-width: 360px;
        }

        .info-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 24px;
            text-align: center;
            border: 1px solid #2c2c2e;
        }

        .info-val {
            display: block;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
            font-variant-numeric: tabular-nums;
            color: var(--ios-green);
        }

        .info-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .console-log {
            width: 100%;
            height: 120px;
            background: #000;
            border-top: 1px solid #1c1c1e;
            padding: 12px;
            font-family: "SF Mono", "Menlo", monospace;
            font-size: 11px;
            color: #555;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        .log-line { margin-bottom: 4px; border-left: 2px solid transparent; padding-left: 8px; }
        .log-line.active { color: var(--ios-blue); border-color: var(--ios-blue); }
        .log-line.error { color: var(--ios-red); border-color: var(--ios-red); }
        .log-line.gps { color: var(--ios-green); border-color: var(--ios-green); }

        #pwa-shield {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .footer-note {
            font-size: 12px;
            color: #444;
            text-align: center;
            line-height: 1.4;
            padding: 0 20px;
        }
    </style>
</head>
<body>

    <div id="pwa-shield">
        <h2 style="color: var(--ios-blue); margin-bottom: 10px;">NAVİGASYON MODU</h2>
        <p style="font-size: 15px; line-height: 1.6; color: #ccc;">iOS arka plan kısıtlamalarını aşmak ve <b>Mavi Konum Çubuğunu</b> aktif etmek için bu uygulamayı Ana Ekrana eklemelisiniz.</p>
        <div style="font-size: 40px; margin: 30px 0;">⬇️</div>
        <p style="font-size: 13px; color: #666;">Paylaş butonuna dokunun ve <br><b>"Ana Ekrana Ekle"</b> seçeneğini bulun.</p>
    </div>

    <div class="safe-top"></div>

    <div class="container">
        <div class="header">
            <div id="statusIndicator" class="status-pill">
                <div class="pulse-dot"></div>
                SİSTEM DURUMU: <span id="statusLabel">HAZIR</span>
            </div>
        </div>

        <div id="orbContainer" class="main-display">
            <div class="radar-ring"></div>
            <div class="radar-ring"></div>
            <div class="radar-ring"></div>
            <button id="mainBtn" class="control-btn">BAŞLAT</button>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <span id="coordDisplay" class="info-val">KONUM BEKLENİYOR...</span>
                <span class="info-label">CANLI GPS KOORDİNATLARI</span>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">AĞ PAKETİ: <span id="pingDisplay">0</span></div>
            </div>
        </div>

        <div class="footer-note">
            Başlattıktan sonra ana ekrana dönün. Üstte mavi simge/saat göründüğünde hotspot bağlantınız korunacaktır.
        </div>
    </div>

    <div id="consoleLog" class="console-log"></div>
    <div class="safe-bottom"></div>

    <script>
        let isActive = false;
        let pingCount = 0;
        let watchId = null;
        let audioCtx = null;
        let loopTimer = null;

        const mainBtn = document.getElementById('mainBtn');
        const orb = document.getElementById('orbContainer');
        const statusLabel = document.getElementById('statusLabel');
        const statusIndicator = document.getElementById('statusIndicator');
        const coordDisplay = document.getElementById('coordDisplay');
        const pingDisplay = document.getElementById('pingDisplay');
        const consoleLog = document.getElementById('consoleLog');

        // PWA Standalone Check
        if (!window.navigator.standalone && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
            document.getElementById('pwa-shield').style.display = 'flex';
        }

        function pushLog(msg, type = '') {
            const el = document.createElement('div');
            el.className = `log-line ${type}`;
            el.innerText = `[${new Date().toLocaleTimeString('tr-TR')}] ${msg}`;
            consoleLog.prepend(el);
            if (consoleLog.children.length > 50) consoleLog.lastChild.remove();
        }

        // Web Audio Engine: Constant high-priority process
        function startAudioEngine() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 1, audioCtx.sampleRate);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                
                const gain = audioCtx.createGain();
                gain.gain.value = 0.001; 
                
                source.connect(gain);
                gain.connect(audioCtx.destination);
                source.start();

                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'Hotspot Navigation Anchor',
                        artist: 'Background GPS Engine',
                        album: 'Live Mode'
                    });
                }
                pushLog("Ses motoru uyanık.", "active");
            } catch (e) {
                pushLog("Ses motoru hatası: " + e.message, "error");
            }
        }

        // The "Network Heartbeat" to keep radio interface from sleeping
        async function runNetworkLoop() {
            if (!isActive) return;

            try {
                await fetch(`https://www.google.com/generate_204?v=${Date.now()}`, { 
                    mode: 'no-cors', 
                    cache: 'no-store' 
                });
                pingCount++;
                pingDisplay.innerText = pingCount;
            } catch (err) {}

            loopTimer = setTimeout(runNetworkLoop, 3500);
        }

        function handleLocationUpdate(pos) {
            if (!isActive) return;
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const accuracy = pos.coords.accuracy.toFixed(1);
            
            coordDisplay.innerText = `${lat}, ${lng}`;
            
            if (pingCount % 5 === 0) {
                pushLog(`GPS GÜNCEL: ${lat}, ${lng} (±${accuracy}m)`, "gps");
            }
        }

        async function startSystem() {
            pushLog("Sistem yetkilendiriliyor...");
            
            // Explicit prompt and first fix
            navigator.geolocation.getCurrentPosition(async (pos) => {
                pushLog("GPS İzni Onaylandı. Takip Başlıyor.", "active");
                
                startAudioEngine();
                
                isActive = true;
                handleLocationUpdate(pos);

                // Start watchPosition for persistent "Blue Bar" indicator and REAL-TIME updates
                // iOS uses this to determine if an app is a "Navigation" app.
                watchId = navigator.geolocation.watchPosition(
                    handleLocationUpdate,
                    (err) => {
                        let errMsg = "Konum hatası";
                        if(err.code === 1) errMsg = "İzin reddedildi";
                        if(err.code === 2) errMsg = "Konum bulunamadı";
                        if(err.code === 3) errMsg = "Zaman aşımı";
                        pushLog(errMsg + ": " + err.message, "error");
                    },
                    { 
                        enableHighAccuracy: true, 
                        maximumAge: 0, 
                        timeout: 10000 
                    }
                );

                runNetworkLoop();

                // UI Transitions
                mainBtn.innerText = "DURDUR";
                mainBtn.classList.add('active');
                orb.classList.add('active');
                statusIndicator.classList.add('active');
                statusLabel.innerText = "NAVİGASYON AKTİF";
                pushLog("Mavi Çubuk tetiklendi. Arka planda güvenle çalışır.", "active");

            }, (err) => {
                alert("HATA: Konum izni olmadan hotspot koruması çalışamaz. Lütfen ayarlardan izin verin.");
                pushLog("İzin reddedildi.", "error");
            }, { enableHighAccuracy: true, timeout: 15000 });
        }

        function stopSystem() {
            isActive = false;
            clearTimeout(loopTimer);
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
            if (audioCtx) audioCtx.close();

            mainBtn.innerText = "BAŞLAT";
            mainBtn.classList.remove('active');
            orb.classList.remove('active');
            statusIndicator.classList.remove('active');
            statusLabel.innerText = "HAZIR";
            coordDisplay.innerText = "KONUM BEKLENİYOR...";
            pushLog("Sistem durduruldu.");
        }

        mainBtn.addEventListener('click', () => {
            if (!isActive) startSystem();
            else stopSystem();
        });

        const manifestData = {
            name: "Hotspot Nav Anchor",
            short_name: "Hotspot",
            display: "standalone",
            start_url: ".",
            background_color: "#000000",
            theme_color: "#000000"
        };
        const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HS Live Tracker</title>
    
    <!-- iOS PWA Meta Etiketleri -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hotspot">
    <link rel="apple-touch-icon" href="https://www.google.com/favicon.ico">

    <style>
        :root {
            --bg: #000;
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --surface: #1C1C1E;
        }

        body {
            background-color: var(--bg);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none;
        }

        .safe-top { height: env(safe-area-inset-top); }
        .safe-bottom { height: env(safe-area-inset-bottom); }

        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-top: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--surface);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid #333;
        }

        .status-badge.active { color: var(--blue); border-color: var(--blue); }
        .status-badge .dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .active .dot { animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .main-orb {
            position: relative;
            width: 220px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid var(--blue);
            border-radius: 50%;
            opacity: 0;
        }

        .active .radar { animation: radar-ping 3s infinite linear; }

        @keyframes radar-ping {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .btn-start {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: none;
            background: var(--blue);
            color: white;
            font-size: 20px;
            font-weight: 800;
            z-index: 10;
            box-shadow: 0 0 30px rgba(10, 132, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-start.active { background: var(--red); box-shadow: 0 0 30px rgba(255, 69, 58, 0.4); }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 340px;
        }

        .stat-card {
            background: var(--surface);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-val { display: block; font-size: 22px; font-weight: 700; margin-bottom: 4px; font-variant-numeric: tabular-nums; }
        .stat-lbl { font-size: 10px; color: #8E8E93; text-transform: uppercase; }

        .logger {
            width: 100%;
            height: 100px;
            background: #000;
            border-top: 1px solid #222;
            padding: 10px;
            font-family: monospace;
            font-size: 10px;
            color: #555;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        #setup-guide {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>

    <div id="setup-guide">
        <h2 style="color: var(--blue)">KİŞİSEL ERİŞİM NOKTASI KORUYUCU</h2>
        <p style="font-size: 14px; line-height: 1.5;">iOS'ta arka plan konum takibi ve mavi çubuk için bu uygulamayı <b>Ana Ekrana Eklemeniz</b> zorunludur.</p>
        <div style="font-size: 40px; margin: 20px 0;">⬇️</div>
        <p style="font-size: 12px; color: #666;">Paylaş butonuna dokunun ve "Ana Ekrana Ekle" seçeneğini seçin.</p>
    </div>

    <div class="safe-top"></div>

    <div class="app-container">
        <div class="header">
            <div id="statusIndicator" class="status-badge">
                <div class="dot"></div>
                SİSTEM: <span id="statusLabel">BEKLEMEDE</span>
            </div>
        </div>

        <div id="orbContainer" class="main-orb">
            <div class="radar"></div>
            <div class="radar" style="animation-delay: 1s"></div>
            <button id="actionBtn" class="btn-start">BAŞLAT</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <span id="posVal" class="stat-val">---</span>
                <span class="stat-lbl">GPS DURUMU</span>
            </div>
            <div class="stat-card">
                <span id="netVal" class="stat-val">0</span>
                <span class="stat-lbl">PAKET SAYISI</span>
            </div>
        </div>

        <p style="font-size: 11px; color: #444; text-align: center; margin: 0 20px;">
            BAŞLAT'a dokunun ve ana ekrana dönün. Mavi konum simgesi çıktığında Hotspot asla kapanmayacaktır.
        </p>
    </div>

    <div id="logView" class="logger"></div>
    <div class="safe-bottom"></div>

    <script>
        let running = false;
        let pings = 0;
        let watchId = null;
        let audioCtx = null;
        let keepAliveTimer = null;

        const actionBtn = document.getElementById('actionBtn');
        const orb = document.getElementById('orbContainer');
        const statusLabel = document.getElementById('statusLabel');
        const statusIndicator = document.getElementById('statusIndicator');
        const posVal = document.getElementById('posVal');
        const netVal = document.getElementById('netVal');
        const logView = document.getElementById('logView');

        // PWA Standalone Kontrolü
        if (!window.navigator.standalone && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
            document.getElementById('setup-guide').style.display = 'flex';
        }

        function addLog(msg, type = '') {
            const entry = document.createElement('div');
            entry.style.color = type === 'success' ? '#30D158' : (type === 'error' ? '#FF453A' : '#666');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logView.prepend(entry);
            if (logView.children.length > 30) logView.lastChild.remove();
        }

        // Web Audio API: Kesintisiz sessiz sinyal döngüsü
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            
            const gain = audioCtx.createGain();
            gain.gain.value = 0.01; // Minimum duyulmaz seviye
            
            source.connect(gain);
            gain.connect(audioCtx.destination);
            source.start();
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'Hotspot Anchor',
                    artist: 'Live GPS Navigation'
                });
            }
        }

        async function loop() {
            if (!running) return;

            try {
                // 1. Ağ Trafiği (Hotspot'u uyanık tutar)
                await fetch('https://www.google.com/generate_204', { mode: 'no-cors', cache: 'no-store' });
                pings++;
                netVal.innerText = pings;

                // 2. Agresif GPS Dürtmesi (Mavi Çubuk Garantisi)
                // Her loop'ta anlık konum çekerek OS'i "bu uygulama navigasyon yapıyor" modunda tutuyoruz.
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        posVal.innerText = "AKTİF";
                        posVal.style.color = "var(--green)";
                        if (pings % 5 === 0) addLog("Konum Güncellendi: " + p.coords.latitude.toFixed(4), "success");
                    },
                    (e) => {
                        addLog("GPS Sinyal Hatası: " + e.code, "error");
                        posVal.innerText = "KAYIP";
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } catch (e) {
                addLog("Bağlantı dürtme hatası", "error");
            }

            keepAliveTimer = setTimeout(loop, 4000); // 4 saniyede bir tetikle
        }

        async function start() {
            // İzinleri kontrol et ve başlat
            try {
                addLog("Sistem başlatılıyor...");
                
                // Audio başlat (User gesture içinde)
                initAudio();

                // 1. Navigasyon Tipi watchPosition (Mavi Çubuğu Tetikler)
                watchId = navigator.geolocation.watchPosition(
                    () => {}, 
                    (e) => addLog("Watch Error: " + e.message, "error"),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );

                running = true;
                loop();

                // UI
                actionBtn.innerText = "DURDUR";
                actionBtn.classList.add('active');
                orb.classList.add('active');
                statusIndicator.classList.add('active');
                statusLabel.innerText = "CANLI TAKİP";
                addLog("Mavi Konum Çubuğu Aktif Edildi", "success");

            } catch (err) {
                addLog("Başlatma Hatası: " + err.message, "error");
            }
        }

        function stop() {
            running = false;
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (audioCtx) audioCtx.close();
            if (keepAliveTimer) clearTimeout(keepAliveTimer);

            actionBtn.innerText = "BAŞLAT";
            actionBtn.classList.remove('active');
            orb.classList.remove('active');
            statusIndicator.classList.remove('active');
            statusLabel.innerText = "BEKLEMEDE";
            posVal.innerText = "---";
            posVal.style.color = "";
            addLog("Sistem durduruldu.");
        }

        actionBtn.addEventListener('click', () => {
            if (!running) start();
            else stop();
        });

        // Manifest injection
        const manifest = {
            name: "Hotspot Live Anchor",
            short_name: "Hotspot",
            display: "standalone",
            start_url: ".",
            background_color: "#000000",
            theme_color: "#000000"
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = URL.createObjectURL(blob);
        document.head.appendChild(link);
    </script>
</body>
</html>